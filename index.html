<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade Analyzer</title>
<style>
    body { font-family: Arial; background:#f5f5f5; padding:20px; }
    .box { background:white; padding:20px; border-radius:10px; max-width:700px; margin:auto; }
    h2 { text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
</style>
</head>
<body>

<div class="box">
    <h2>Trade Analyzer</h2>
    <input type="file" id="file" accept=".csv">
    <div id="result"></div>
</div>

<script>
function normalize(str) {
    return str.toLowerCase().replace(/[^a-z0-9]/g,"");
}

function findColumn(headers, possibleNames) {
    let normalized = headers.map(h => normalize(h));
    for (let name of possibleNames) {
        let n = normalize(name);
        let index = normalized.indexOf(n);
        if (index !== -1) return headers[index];
    }
    return null;
}

document.getElementById("file").addEventListener("change", function(){
    let file = this.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function(e){
        let lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");

        // ******** اقرأ العناوين ********
        let headerLine = lines[0];
        let headers = headerLine.replace(/"/g,"").split(",");

        // ******** نحدد الأعمدة بدكاء ********
        let colDate  = findColumn(headers, ["Trade Date","Date"]);
        let colEntry = findColumn(headers, ["Entry Time","EntryTime"]);
        let colExit  = findColumn(headers, ["Exit Time","ExitTime"]);
        let colSide  = findColumn(headers, ["Buy/Sell","Side","Entry Buy/Sell"]);
        let colEntryP= findColumn(headers, ["Entry Price","Price","EntryPrice"]);
        let colExitP = findColumn(headers, ["Exit Price","ExitPrice"]);
        let colPnL   = findColumn(headers, ["P/L","Realized PnL","Net P&L","ProfitLoss"]);

        let required = [colDate,colEntry,colExit,colSide,colEntryP,colExitP,colPnL];

        if (required.includes(null)) {
            document.getElementById("result").innerHTML =
                "<p style='color:red'>⚠ CSV غير مفهوم — خاصك CSV ديال RTrader الأصلي فقط.</p>";
            return;
        }

        // ******** نقرأ البيانات ********
        let trades = [];
        for (let i=1; i<lines.length; i++){
            let parts = lines[i].replace(/"/g,"").split(",");
            if (parts.length < headers.length) continue;

            let row = {};
            headers.forEach((h,idx)=>{
                row[h] = parts[idx];
            });

            trades.push({
                date: row[colDate],
                entryTime: row[colEntry],
                exitTime: row[colExit],
                side: row[colSide],
                entryPrice: parseFloat(row[colEntryP]),
                exitPrice: parseFloat(row[colExitP]),
                pnl: parseFloat(row[colPnL])
            });
        }

        // ******** نعرض النتائج ********
        let html = "<table><tr><th>Date</th><th>Side</th><th>Entry</th><th>Exit</th><th>PnL</th></tr>";
        let total = 0;
        trades.forEach(t=>{
            html += `<tr>
                <td>${t.date}</td>
                <td>${t.side}</td>
                <td>${t.entryPrice}</td>
                <td>${t.exitPrice}</td>
                <td>${t.pnl}</td>
            </tr>`;
            total += t.pnl;
        });
        html += `</table><h3>Total PnL: ${total.toFixed(2)}</h3>`;

        document.getElementById("result").innerHTML = html;
    };

    reader.readAsText(file);
});
</script>

</body>
</html>
